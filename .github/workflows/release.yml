name: Release images

on:
   push:
      tags:
         - "v*"
   workflow_dispatch:

permissions:
   contents: write
   packages: write

jobs:
   release:
      name: Build, push images and publish GitHub Release
      runs-on: ubuntu-latest
      steps:
         - uses: actions/checkout@v4

         - name: Set up QEMU
           uses: docker/setup-qemu-action@v3

         - name: Set up Docker Buildx
           uses: docker/setup-buildx-action@v3

         - name: Log in to GHCR
           uses: docker/login-action@v3
           with:
              registry: ghcr.io
              username: ${{ github.repository_owner }}
              password: ${{ secrets.GITHUB_TOKEN }}

         - name: Compute image names and version
           id: vars
           run: |
              OWNER_LC=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
              REPO_LC=$(echo "${{ github.event.repository.name }}" | tr '[:upper:]' '[:lower:]')
              VERSION="${GITHUB_REF_NAME}"
              echo "owner_lc=$OWNER_LC" >> $GITHUB_OUTPUT
              echo "repo_lc=$REPO_LC" >> $GITHUB_OUTPUT
              echo "version=$VERSION" >> $GITHUB_OUTPUT

         - name: Build and push backend image
           uses: docker/build-push-action@v6
           with:
              context: ./backend
              file: ./backend/Dockerfile
              platforms: linux/amd64
              push: true
              tags: |
                 ghcr.io/${{ steps.vars.outputs.owner_lc }}/${{ steps.vars.outputs.repo_lc }}-backend:${{ steps.vars.outputs.version }}
                 ghcr.io/${{ steps.vars.outputs.owner_lc }}/${{ steps.vars.outputs.repo_lc }}-backend:latest

         - name: Build and push frontend image
           uses: docker/build-push-action@v6
           with:
              context: ./front
              file: ./front/Dockerfile
              platforms: linux/amd64
              push: true
              tags: |
                 ghcr.io/${{ steps.vars.outputs.owner_lc }}/${{ steps.vars.outputs.repo_lc }}-front:${{ steps.vars.outputs.version }}
                 ghcr.io/${{ steps.vars.outputs.owner_lc }}/${{ steps.vars.outputs.repo_lc }}-front:latest

         - name: Pull and export backend image
           run: |
              docker pull ghcr.io/${{ steps.vars.outputs.owner_lc }}/${{ steps.vars.outputs.repo_lc }}-backend:${{ steps.vars.outputs.version }}
              docker save ghcr.io/${{ steps.vars.outputs.owner_lc }}/${{ steps.vars.outputs.repo_lc }}-backend:${{ steps.vars.outputs.version }} | gzip > backend-image-${{ steps.vars.outputs.version }}.tar.gz

         - name: Pull and export frontend image
           run: |
              docker pull ghcr.io/${{ steps.vars.outputs.owner_lc }}/${{ steps.vars.outputs.repo_lc }}-front:${{ steps.vars.outputs.version }}
              docker save ghcr.io/${{ steps.vars.outputs.owner_lc }}/${{ steps.vars.outputs.repo_lc }}-front:${{ steps.vars.outputs.version }} | gzip > front-image-${{ steps.vars.outputs.version }}.tar.gz

         - name: Publish GitHub Release
           uses: softprops/action-gh-release@v2
           env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
           with:
              files: |
                 backend-image-${{ steps.vars.outputs.version }}.tar.gz
                 front-image-${{ steps.vars.outputs.version }}.tar.gz
              generate_release_notes: true
