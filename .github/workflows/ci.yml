name: CI

on:
   push:
      branches:
         - main
         - release
   pull_request:
      branches:
         - main
         - release

permissions:
   contents: read

jobs:
   backend:
      name: Backend - Maven build
      runs-on: ubuntu-latest
      defaults:
         run:
            working-directory: backend
      steps:
         - uses: actions/checkout@v4
         - name: Set up JDK 17
           uses: actions/setup-java@v4
           with:
              distribution: temurin
              java-version: "17"
              cache: maven
         - name: Build backend
           run: mvn -B -ntp -DskipTests package
         - name: Upload backend jar
           uses: actions/upload-artifact@v4
           with:
              name: backend-jar
              path: backend/target/*.jar
              if-no-files-found: warn

   frontend:
      name: Frontend - Node build
      runs-on: ubuntu-latest
      defaults:
         run:
            working-directory: front
      steps:
         - uses: actions/checkout@v4
         - name: Setup Node.js 20
           uses: actions/setup-node@v4
           with:
              node-version: "20"
              cache: npm
              cache-dependency-path: front/package-lock.json
         - name: Install dependencies
           run: npm ci
         - name: Lint
           run: npm run lint --if-present
         - name: Build
           run: npm run build
         - name: Upload frontend dist
           uses: actions/upload-artifact@v4
           with:
              name: frontend-dist
              path: front/dist
              if-no-files-found: warn

   dockerfiles:
      name: Dockerfiles - Build check
      runs-on: ubuntu-latest
      needs: [backend, frontend]
      steps:
         - uses: actions/checkout@v4
         - name: Set up QEMU
           uses: docker/setup-qemu-action@v3
         - name: Set up Docker Buildx
           uses: docker/setup-buildx-action@v3
         - name: Build backend image (no push)
           uses: docker/build-push-action@v6
           with:
              context: .
              file: ./backend/Dockerfile
              push: false
              tags: temp/backend:ci
         - name: Build frontend image (no push)
           uses: docker/build-push-action@v6
           with:
              context: ./front
              file: ./front/Dockerfile
              push: false
              tags: temp/frontend:ci
